<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Calendrier 4 semaines - propre</title>

<style>
:root{
  --bg:#121212;
  --card:#1c1f23;
  --border:#555;
  --text:#eaeaea;
  --muted:#999;
  --accent:#00e5ff;
  --gap:4px;
  --days-font:14px;
  --event-font:14px;
}

body{
  margin:0;
  font-family:Inter, system-ui, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
  box-sizing:border-box;
}

.container{
  max-width:1600px;
  margin:0 auto;
}

header{
  display:flex;
  justify-content:center;
  align-items:center;
  margin-bottom:10px;
  gap:20px;
}

header button{
  background:none;
  border:none;
  color:var(--accent);
  font-size:22px;
  cursor:pointer;
  padding:6px 10px;
  border-radius:6px;
}
header button:hover{
  background:rgba(0,229,255,0.15);
}

header h1{
  margin:0;
  font-size:24px;
  color:var(--accent);
}

.calendar{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
  width:100%;
}

.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:var(--gap);
}

.day{
  background:#141619;
  border-radius:12px;
  height:calc((100vh - 120px)/4);
  padding:12px;
  border:1px solid var(--border);
  box-sizing:border-box;
  position:relative;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  transition: transform .35s, background .25s, box-shadow .35s, border-color .25s;
}

/* Animation du jour actuel */
@keyframes pulseToday {
  0%,100%{ transform:scale(1.08); }
  50%{ transform:scale(1.12); }
}

.day.today{
  transform:scale(1.08);
  background:#1f2226;
  border:2px solid var(--accent);
  z-index:3;
  animation:pulseToday 3s ease-in-out infinite;
}
.day.today::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:12px;
  box-shadow:0 0 20px 8px rgba(0,229,255,0.35);
  pointer-events:none;
}

/* Passé / futur */
.day.past{
  background:#0f1113;
  color:#555;
  transform:scale(.95);
}
.day.future{
  background:#1c1f23;
  color:#eaeaea;
}

/* Hover pour tous */
.day:hover{
  transform:scale(1.22);
  background:#23272c;
  z-index:10;
  box-shadow:0 12px 40px rgba(0,0,0,0.45);
}

.day-header{
  display:flex;
  justify-content:space-between;
  font-size:var(--days-font);
  margin-bottom:6px;
}

.date{
  font-weight:600;
  font-size:var(--days-font);
}

.events{
  flex:1 1 auto;
  display:flex;
  flex-direction:column;
  gap:2px;
  overflow:hidden;
}

.event{
  display:flex;
  align-items:center;
  gap:4px;
  padding:3px 4px;
  background:rgba(0,0,0,0.33);
  border-radius:6px;
  font-size:var(--event-font);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  cursor:pointer;
}
.event:hover{ background:rgba(0,0,0,0.5); }

.event .time{
  min-width:45px;
  font-weight:600;
  font-size:12px;
}

.event.allDay .time{ display:none; }

.event.more{
  color:var(--muted);
  font-size:13px;
  padding-left:6px;
}

.c-reception{ color:#17d36b; }
.c-smr{ color:#6571ff; }

/* POPUP */
#popup{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:18px;
  background:#1c1f23;
  color:white;
  min-width:320px;
  max-width:90%;
  border-radius:12px;
  z-index:30;
  display:none;
  box-shadow:0 0 30px rgba(0,0,0,0.7);
}
#popup h3{ margin-top:0; }
#popup .close{
  position:absolute;
  top:8px;
  right:12px;
  cursor:pointer;
  font-size:20px;
  font-weight:bold;
}
</style>

</head>
<body>

<div class="container">
  <header>
    <button id="prev-week">&lt;</button>
    <h1 id="month-title">Mois</h1>
    <button id="next-week">&gt;</button>
  </header>

  <div class="calendar">
    <div class="grid" id="grid"></div>
  </div>
</div>

<!-- POPUP -->
<div id="popup">
  <span class="close" onclick="popup.style.display='none'">&times;</span>
  <h3 id="popup-title"></h3>
  <div id="popup-time"></div>
</div>

<script>
// --- CONFIG ---
const API_KEY = "AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo";

const CALENDARS = [
  { id:"receptionroulier@gmail.com", key:"reception", css:"c-reception" },
  { id:"smr.programme@gmail.com", key:"smr", css:"c-smr" }
];

const WEEKS = 4;

// --- UTILITAIRES ---
function fmtDate(d){ return d.toISOString().split("T")[0]; }
function pad(n){ return n<10?"0"+n:n; }
function fmtTime(dt){ if(!dt) return ""; const d=new Date(dt); return pad(d.getHours())+":"+pad(d.getMinutes()); }
function fmtPopupDate(dt){ const d=new Date(dt); const dn=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"]; return dn[d.getDay()]+" "+d.getDate(); }
function shortTitle(s,max=60){ if(!s) return ""; return s.length>max ? s.slice(0,max-1)+"…" : s; }

// --- STRUCTURE DES SEMAINES ---
let gridStartDate = computeGridStart(new Date());

function computeGridStart(ref){
  const d=new Date(ref);
  const wd=d.getDay();
  const monday=new Date(d);
  monday.setDate(d.getDate() - ((wd+6)%7));
  monday.setDate(monday.getDate() - 7);
  return monday;
}

function buildDates(start){
  const arr=[];
  for(let w=0; w<WEEKS; w++){
    for(let i=0;i<7;i++){
      const d=new Date(start);
      d.setDate(start.getDate()+ w*7 + i);
      arr.push(new Date(d));
    }
  }
  return arr;
}

// --- POPUP ---
function showPopup(title,start,end,isAllDay){
  const popup=document.getElementById("popup");
  document.getElementById("popup-title").textContent = title;

  let txt = isAllDay ? 
    "Toute la journée" : 
    "Du " + start + " au " + end;

  document.getElementById("popup-time").textContent = txt;

  popup.style.display="block";
}

// --- API Google Calendar ---
async function fetchEvents(calId, tMin, tMax){
  const url = 
    "https://www.googleapis.com/calendar/v3/calendars/" +
    encodeURIComponent(calId) +
    "/events?key=" + encodeURIComponent(API_KEY) +
    "&timeMin=" + encodeURIComponent(tMin) +
    "&timeMax=" + encodeURIComponent(tMax) +
    "&singleEvents=true&orderBy=startTime&maxResults=2500";

  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

// --- RENDER ---
async function renderCalendar(){
  const grid = document.getElementById("grid");
  const dates = buildDates(gridStartDate);

  const monthNames=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  document.getElementById("month-title").textContent =
    monthNames[dates[7].getMonth()] + " " + dates[7].getFullYear();

  grid.innerHTML="";

  // placement des cases
  dates.forEach(d=>{
    const el=document.createElement("div");
    el.className="day";
    el.dataset.date=fmtDate(d);
    el.innerHTML =
      `<div class="day-header">
         <div>${["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()]}</div>
         <div class="date">${d.getDate()}</div>
       </div>
       <div class="events"></div>`;
    grid.appendChild(el);
  });

  // intervalle pour API
  const tMin = new Date(dates[0]);
  tMin.setHours(0,0,0,0);
  const tMax = new Date(dates[dates.length-1]);
  tMax.setHours(23,59,59,999);

  let eventsByDay = {};
  const seen = new Set();

  try{
    const responses = await Promise.all(
      CALENDARS.map(c=>fetchEvents(c.id,tMin.toISOString(),tMax.toISOString())
        .then(json=>({calendar:c,items:json.items||[]}))
        .catch(()=>({calendar:c,items:[]})))
    );

    for(const res of responses){
      const meta = res.calendar;

      for(const ev of res.items){
        const key = ev.iCalUID || ev.id;
        if(seen.has(key)) continue;
        seen.add(key);

        const isAllDay = !!ev.start.date && !ev.start.dateTime;
        const start = ev.start.dateTime || ev.start.date;
        const end   = ev.end.dateTime   || ev.end.date;

        if(isAllDay){
          const s = new Date(start+"T00:00:00");
          const e = new Date(end+"T00:00:00");
          for(let d=new Date(s); d<e; d.setDate(d.getDate()+1)){
            const k = fmtDate(d);
            eventsByDay[k] = eventsByDay[k]||[];
            eventsByDay[k].push({
              title:ev.summary||"(sans titre)",
              start:null, end:null,
              allDay:true,
              calendarKey:meta.key
            });
          }
        }else{
          const k = fmtDate(new Date(start));
          eventsByDay[k] = eventsByDay[k]||[];
          eventsByDay[k].push({
            title:ev.summary||"(sans titre)",
            start:start,
            end:end,
            allDay:false,
            calendarKey:meta.key
          });
        }
      }
    }

    // remplir les jours
    const todayStr = fmtDate(new Date());

    for(const dayEl of Array.from(document.querySelectorAll(".day"))){
      const d = dayEl.dataset.date;
      const evList = eventsByDay[d] || [];
      const container = dayEl.querySelector(".events");
      container.innerHTML="";

      // tri
      evList.sort((a,b)=>{
        if(a.allDay && !b.allDay) return -1;
        if(!a.allDay && b.allDay) return 1;
        if(a.allDay && b.allDay) return 0;
        return new Date(a.start) - new Date(b.start);
      });

      // limite d'affichage
      const MAX = 6;
      const show = evList.slice(0,MAX);

      for(const ev of show){
        const el=document.createElement("div");
        el.className="event"+(ev.allDay?" allDay":"");

        const calMeta = CALENDARS.find(c=>c.key===ev.calendarKey);
        if(calMeta) el.classList.add(calMeta.css);

        const timeStart = ev.allDay ? 
          "Toute la journée" :
          fmtPopupDate(ev.start)+" "+fmtTime(ev.start);

        const timeEnd = ev.end ?
          fmtPopupDate(ev.end)+" "+fmtTime(ev.end) :
          timeStart;

        el.innerHTML =
          `<div class="time">${ev.allDay?"":fmtTime(ev.start)}</div>
           <div class="title">${shortTitle(ev.title,80)}</div>`;

        el.onclick = ()=>showPopup(ev.title, timeStart, timeEnd, ev.allDay);

        container.appendChild(el);
      }

      if(evList.length > MAX){
        const moreEl=document.createElement("div");
        moreEl.className="event more";
        moreEl.textContent = "+ "+(evList.length-MAX)+" autres";
        container.appendChild(moreEl);
      }

      // état du jour
      dayEl.classList.remove("past","today","future");
      if(d === todayStr) dayEl.classList.add("today");
      else if(d < todayStr) dayEl.classList.add("past");
      else dayEl.classList.add("future");
    }

  }catch(e){
    console.error("Erreur:",e);
  }
}

// --- NAVIGATION ---
document.getElementById("prev-week").onclick = ()=>{
  gridStartDate.setDate(gridStartDate.getDate()-7);
  renderCalendar();
};
document.getElementById("next-week").onclick = ()=>{
  gridStartDate.setDate(gridStartDate.getDate()+7);
  renderCalendar();
};

// INIT
renderCalendar();
setInterval(renderCalendar, 60000); // auto refresh

</script>

</body>
</html>
