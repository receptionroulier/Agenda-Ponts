<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calendrier 4 semaines</title>
<style>
:root{
  --bg:#121212;
  --card:#1c1f23;
  --border:#555;
  --text:#eaeaea;
  --muted:#999;
  --accent:#00e5ff;
  --gap:6px;
  --days-font:14px;
  --event-font:14px;
}

/* reset/layout */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter, system-ui, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}
.container{ max-width:1600px; margin:0 auto; }

/* header: controls left, title centered, optional right area */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.header-left{
  display:flex;
  gap:8px;
  align-items:center;
}
.header-right{
  display:flex;
  gap:8px;
  align-items:center;
}
#month-title{
  flex:1;
  text-align:center;
  font-size:22px;
  color:var(--accent);
  margin:0;
}
button.ctrl{
  background:none;
  border:1px solid rgba(255,255,255,0.06);
  color:var(--accent);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
}
button.ctrl:hover{ background: rgba(0,229,255,0.08); }

/* calendar card */
.calendar{ background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.5); }

/* grid: 7 columns */
.grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:var(--gap); }

/* day cell - fixed height by default */
.day{
  background:#141619;
  border-radius:12px;
  padding:12px;
  border:1px solid var(--border);
  height: calc((100vh - 160px)/4);
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  position:relative;
  overflow:hidden;
  transition:
    transform .32s ease,
    background .22s ease,
    box-shadow .32s ease,
    max-height .35s ease;
  max-height: calc((100vh - 160px)/4); /* used for smooth expansion */
}

/* header inside cell */
.day-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-size:var(--days-font); }
.day .date{ font-weight:600; font-size:var(--days-font); }

/* events list */
.events{ display:flex; flex-direction:column; gap:6px; overflow:hidden; flex:1 1 auto; }

/* event (single line default) */
.event{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 8px;
  border-radius:8px;
  background:rgba(0,0,0,0.33);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  cursor:pointer;
  font-size:var(--event-font);
  transition: background .15s;
}
.event:hover{ background:rgba(0,0,0,0.55); }
.event .time{ min-width:48px; font-weight:600; font-size:12px; }
.event .title{ text-align:left; }

/* more */
.event.more{ color:var(--muted); font-size:13px; padding-left:6px; }

/* calendar colors */
.c-reception{ color:#19d26d; }
.c-smr{ color:#6c76ff; }

/* popup (always above) */
#popup{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  min-width:320px;
  max-width:90%;
  background:#1c1f23;
  color:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:0 10px 40px rgba(0,0,0,0.7);
  z-index:9999;
  display:none;
}
#popup h3{ margin:0 0 8px 0; font-size:18px; }
#popup .close{ position:absolute; right:12px; top:8px; cursor:pointer; font-size:18px; }

/* ---------- Special: today / future / past ---------- */

/* today: slight base zoom + pulse, 3D permanent halo (via ::after) */
@keyframes pulseToday { 0%,100%{ transform:scale(1.06);} 50%{ transform:scale(1.1);} }
.day.today{
  transform:scale(1.06);
  animation:pulseToday 3s ease-in-out infinite;
  background:#1f2226;
  border:2px solid var(--accent);
  z-index:5;
}
.day.today::after{
  content:"";
  position:absolute;
  inset:-8px;
  border-radius:16px;
  pointer-events:none;
  box-shadow:
    0 8px 30px rgba(0,229,255,0.30),
    0 24px 80px rgba(0,229,255,0.18),
    0 56px 160px rgba(0,229,255,0.08);
}

/* future: default */
.day.future{ background:#1c1f23; color:var(--text); }

/* past: darker, no hover zoom */
.day.past{ background:#0f1113; color:#777; transform:scale(.96); }

/* ---------- Hover rules ---------- */

/* disable hover zoom/halo for past */
.day.past:hover{
  transform:none !important;
  box-shadow:none !important;
  z-index:1 !important;
  max-height: calc((100vh - 160px)/4) !important;
}

/* for today & future: hover zoom + smooth expansion (max-height) */
.day:not(.past):hover{
  transform:scale(1.18);
  z-index:30;
  background:#23272c;
  box-shadow:0 12px 40px rgba(0,0,0,0.45);
  overflow:visible;
  max-height: 700px; /* expanded space to show full title on one line */
}

/* on hover, allow events to wrap so full title fits one line */
.day:not(.past):hover .event{ white-space:normal; }

/* halo on hover for future (simple) */
.day.future:hover::after{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:14px;
  pointer-events:none;
  box-shadow:0 0 28px 10px rgba(0,229,255,0.22);
}

/* stronger halo for today on hover (3D) */
.day.today:hover::after{
  content:"";
  position:absolute;
  inset:-10px;
  border-radius:16px;
  pointer-events:none;
  box-shadow:
    0 14px 40px rgba(0,229,255,0.45),
    0 36px 100px rgba(0,229,255,0.28),
    0 80px 180px rgba(0,229,255,0.12);
}

/* compact mode : smaller cells, hide event list */
.compact .day{
  max-height:110px !important;
  height:110px !important;
  overflow:hidden;
  transform:none !important;
  animation:none !important;
}
.compact .events{ display:none; }
.compact .day.today::after{ display:none; }

/* responsive */
@media(max-width:900px){ .grid{ grid-template-columns: repeat(2,1fr); } }
@media(max-width:520px){
  .grid{ grid-template-columns: repeat(1,1fr); }
  .day{ height:auto; max-height:none; }
  .compact .day{ height:auto; max-height:none; }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-left">
      <button id="prev-week" class="ctrl" title="Semaine précédente">←</button>
      <button id="today-btn" class="ctrl" title="Aujourd'hui">Aujourd’hui</button>
      <button id="next-week" class="ctrl" title="Semaine suivante">→</button>
    </div>

    <h1 id="month-title">Mois</h1>

    <div class="header-right">
      <button id="compact-toggle" class="ctrl" title="Basculer mode compact">Compact</button>
    </div>
  </header>

  <div class="calendar">
    <div class="grid" id="grid"></div>
  </div>
</div>

<!-- popup -->
<div id="popup" aria-hidden="true">
  <span class="close" onclick="closePopup()">×</span>
  <h3 id="popup-title"></h3>
  <div id="popup-time"></div>
</div>

<script>
/* ================= CONFIG ================= */
/* Déclarez votre clé une seule fois ici (remplacez) */
const API_KEY = "YOUR_API_KEY_HERE";

const CALENDARS = [
  { id:'receptionroulier@gmail.com', key:'reception', css:'c-reception' },
  { id:'smr.programme@gmail.com', key:'smr', css:'c-smr' }
];

const WEEKS = 4; // 4 semaines affichées
const AUTO_REFRESH_MS = 60*1000; // 60s

/* ================= HELPERS ================= */
function pad(n){ return n<10 ? '0'+n : ''+n; }
function fmtDate(d){ return d.toISOString().split('T')[0]; }
function fmtTime(dt){ if(!dt) return ''; const z=new Date(dt); return pad(z.getHours())+':'+pad(z.getMinutes()); }
function fmtPopupDate(dt){ if(!dt) return ''; const z=new Date(dt); const names=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"]; return names[z.getDay()]+' '+z.getDate(); }
function shortTitle(s,max=120){ if(!s) return ''; return s.length>max ? s.slice(0,max-1)+'…' : s; }

/* ============== GRID START ============== */
function computeGridStart(referenceDate){
  const today = new Date(referenceDate);
  const wd = today.getDay(); // 0=dim
  const mondayThisWeek = new Date(today);
  mondayThisWeek.setDate(today.getDate() - ((wd + 6) % 7));
  const mondayLastWeek = new Date(mondayThisWeek);
  mondayLastWeek.setDate(mondayLastWeek.getDate() - 7);
  return mondayLastWeek;
}
let gridStartDate = computeGridStart(new Date());

function buildDates(start){
  const arr=[];
  for(let w=0; w<WEEKS; w++){
    for(let i=0;i<7;i++){
      const d=new Date(start);
      d.setDate(start.getDate() + w*7 + i);
      arr.push(new Date(d));
    }
  }
  return arr;
}

/* ================= POPUP ================= */
const popup = document.getElementById('popup');
function showPopup(title,start,end,isAllDay){
  document.getElementById('popup-title').textContent = title;
  document.getElementById('popup-time').textContent = isAllDay ? 'Toute la journée' : (start + ' — ' + end);
  popup.style.display = 'block';
  popup.setAttribute('aria-hidden','false');
}
function closePopup(){
  popup.style.display = 'none';
  popup.setAttribute('aria-hidden','true');
}

/* ================= GOOGLE CALENDAR FETCH ================= */
async function fetchEventsForCalendar(calId, timeMin, timeMax){
  if(!API_KEY || API_KEY === "YOUR_API_KEY_HERE"){
    // no key provided — return empty (allows testing without errors)
    return { items: [] };
  }
  const base = 'https://www.googleapis.com/calendar/v3/calendars/';
  const url = base + encodeURIComponent(calId) +
    '/events?key=' + encodeURIComponent(API_KEY) +
    '&timeMin=' + encodeURIComponent(timeMin) +
    '&timeMax=' + encodeURIComponent(timeMax) +
    '&singleEvents=true&orderBy=startTime&maxResults=2500';
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP ' + r.status);
  return r.json();
}

/* ================= RENDER ================= */
async function renderCalendar(){
  const gridEl = document.getElementById('grid');
  const dates = buildDates(gridStartDate);

  const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  document.getElementById('month-title').textContent = monthNames[dates[7].getMonth()] + ' ' + dates[7].getFullYear();

  // clear grid
  gridEl.innerHTML = '';

  // create cells
  dates.forEach(d=>{
    const cell = document.createElement('div');
    cell.className = 'day';
    cell.dataset.date = fmtDate(d);
    cell.innerHTML = `
      <div class="day-header">
        <div class="dow">${["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()]}</div>
        <div class="date">${d.getDate()}</div>
      </div>
      <div class="events"></div>
    `;
    gridEl.appendChild(cell);
  });

  // time range
  const tMin = new Date(dates[0]); tMin.setHours(0,0,0,0);
  const tMax = new Date(dates[dates.length-1]); tMax.setHours(23,59,59,999);

  const eventsByDay = {};
  const seen = new Set();

  try{
    const promises = CALENDARS.map(c => fetchEventsForCalendar(c.id, tMin.toISOString(), tMax.toISOString())
      .then(json => ({ calendar: c, items: json.items || [] }))
      .catch(err => { console.warn('API error',c.id,err); return { calendar:c, items:[] }; })
    );

    const results = await Promise.all(promises);

    for(const res of results){
      const cal = res.calendar;
      for(const it of res.items){
        const dedupe = it.iCalUID || it.id || (it.summary + (it.start?.dateTime || it.start?.date));
        if(seen.has(dedupe)) continue;
        seen.add(dedupe);

        const isAllDay = !!it.start?.date && !it.start?.dateTime;
        const start = it.start?.dateTime || it.start?.date;
        const end = it.end?.dateTime || it.end?.date;

        if(isAllDay){
          const s = new Date(start + 'T00:00:00');
          const e = new Date(end + 'T00:00:00');
          for(let d = new Date(s); d < e; d.setDate(d.getDate()+1)){
            const k = fmtDate(d);
            eventsByDay[k] = eventsByDay[k] || [];
            eventsByDay[k].push({ title: it.summary || '(sans titre)', start:null, end:null, allDay:true, calendarKey: cal.key });
          }
        } else {
          const k = fmtDate(new Date(start));
          eventsByDay[k] = eventsByDay[k] || [];
          eventsByDay[k].push({ title: it.summary || '(sans titre)', start: start, end: end, allDay:false, calendarKey: cal.key });
        }
      }
    }

    // render into cells
    const todayStr = fmtDate(new Date());
    document.querySelectorAll('.day').forEach(cell=>{
      const date = cell.dataset.date;
      const list = (eventsByDay[date] || []).slice();

      // sort
      list.sort((a,b)=>{
        if(a.allDay && !b.allDay) return -1;
        if(!a.allDay && b.allDay) return 1;
        if(a.allDay && b.allDay) return 0;
        return new Date(a.start) - new Date(b.start);
      });

      const container = cell.querySelector('.events');
      container.innerHTML = '';
      const MAX = 6;
      const shown = list.slice(0, MAX);
      for(const ev of shown){
        const evEl = document.createElement('div');
        evEl.className = 'event' + (ev.allDay ? ' allDay' : '');
        const calMeta = CALENDARS.find(c=>c.key === ev.calendarKey);
        if(calMeta) evEl.classList.add(calMeta.css);

        // safe time strings
        const startObj = ev.start ? new Date(ev.start) : null;
        const endObj = ev.end ? new Date(ev.end) : null;

        const timeLabel = ev.allDay ? 'Toute la journée' : (startObj ? fmtTime(startObj) : '');
        const popupStart = ev.allDay ? (date + ' 00:00') : (ev.start ? (fmtPopupDate(ev.start) + ' ' + fmtTime(ev.start)) : '');
        const popupEnd = endObj ? (fmtPopupDate(ev.end) + ' ' + fmtTime(ev.end)) : popupStart;

        evEl.innerHTML = `<div class="time">${ev.allDay ? '' : timeLabel}</div><div class="title">${shortTitle(ev.title,140)}</div>`;
        evEl.onclick = ()=> showPopup(ev.title, popupStart, popupEnd, ev.allDay);
        container.appendChild(evEl);
      }

      if(list.length > MAX){
        const more = document.createElement('div');
        more.className = 'event more';
        more.textContent = '+ ' + (list.length - MAX) + ' autres';
        container.appendChild(more);
      }

      // mark classes
      cell.classList.remove('past','today','future');
      if(date === todayStr) cell.classList.add('today');
      else if(date < todayStr) cell.classList.add('past');
      else cell.classList.add('future');
    });

  }catch(e){
    console.error('Erreur chargement événements', e);
  }
}

/* ================= CONTROLS ================= */
document.getElementById('prev-week').addEventListener('click', ()=>{
  gridStartDate.setDate(gridStartDate.getDate() - 7);
  renderCalendar();
});
document.getElementById('next-week').addEventListener('click', ()=>{
  gridStartDate.setDate(gridStartDate.getDate() + 7);
  renderCalendar();
});
document.getElementById('today-btn').addEventListener('click', ()=>{
  gridStartDate = computeGridStart(new Date());
  renderCalendar();
});

/* compact mode (persistent) */
const COMPACT_KEY = 'calendar_compact_v1';
const compactToggle = document.getElementById('compact-toggle');
function applyCompact(){
  const on = localStorage.getItem(COMPACT_KEY) === '1';
  document.body.classList.toggle('compact', on);
  compactToggle.textContent = on ? 'Compact ✓' : 'Compact';
}
compactToggle.addEventListener('click', ()=>{
  const current = localStorage.getItem(COMPACT_KEY) === '1';
  localStorage.setItem(COMPACT_KEY, current ? '0' : '1');
  applyCompact();
});

/* initialize */
applyCompact();
renderCalendar();
setInterval(renderCalendar, AUTO_REFRESH_MS);
</script>
</body>
</html>
