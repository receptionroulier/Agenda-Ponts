<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calendrier 4 semaines - compact fixe</title>

<style>
:root {
  --bg: #121212;
  --card: #1c1f23;
  --border: #555;
  --text: #eaeaea;
  --muted: #999;
  --accent: #00e5ff;
  --gap: 4px;
  --days-font: 14px;
  --event-font: 13px;
  --compact-days-font: 14px;
  --compact-event-font: 13px;
}

body {
  margin: 0;
  padding: 16px;
  font-family: Inter, system-ui, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  box-sizing: border-box;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
}

header {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
  flex-wrap: wrap;
}

header h1 {
  margin: 0 10px;
  font-size: 24px;
  color: var(--accent);
}

header button {
  background: none;
  border: 1px solid var(--accent);
  color: var(--accent);
  font-size: 14px;
  padding: 4px 8px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.2s;
}

header button:hover {
  background: rgba(0,229,255,0.2);
}

.calendar {
  background: var(--card);
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  width: 100%;
}

.grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: var(--gap);
}

/* ---------------------------------------------
   CASE JOUR - FIXE
--------------------------------------------- */
.day {
  height: calc((100vh - 100px)/4);
  display: flex;
  flex-direction: column;
  padding: 12px;
  box-sizing: border-box;
  overflow: hidden; /* empêche la cellule de s'agrandir */
  position: relative;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: #141619;
  transition: transform 0.35s cubic-bezier(.25,.8,.25,1),
              background-color 0.25s ease,
              box-shadow 0.35s ease,
              border-color 0.25s ease;
}

/* Survol : zoom entier de la case, sans changer la police */
.day:hover {
  transform: scale(1.22);
  z-index: 60;
  background-color: #23272c !important;
  border-color: var(--accent);
  box-shadow: 0 12px 40px rgba(0,0,0,0.45);
}

.day.today { background-color: #1f2226; box-shadow: 0 0 20px rgba(0,229,255,0.3); }
.day.past { background-color: #0f1113; color:#555; }
.day.future { background-color: #1c1f23; color:#eaeaea; }

/* ---------------------------------------------
   EN-TETE DU JOUR
--------------------------------------------- */
.day-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: var(--compact-days-font);
  margin-bottom: 0 !important; /* plus d'espace avec les événements */
}

.date { font-weight:600; font-size: var(--compact-days-font); }

/* ---------------------------------------------
   ÉVÉNEMENTS
--------------------------------------------- */
.events {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-top: 2px !important;
  overflow: hidden;
}

.event {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px;
  border-radius: 6px;
  font-size: var(--compact-event-font);
  line-height: 1.1;
  background: rgba(0,0,0,0.3);
  cursor: pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  justify-content: flex-start;
  max-width: 100%;
  box-sizing: border-box;
}

.event:hover { background: rgba(0,0,0,0.5); }

.event .title { text-align: left; }
.event .time { min-width:50px; font-weight:600; font-size:11px; }
.event.allDay .time { display:none; }
.event.more { font-size:12px; color:var(--muted); padding-left:6px; }

.c-reception { color:#109c53; }
.c-smr { color:#5768cb; }

/* ---------------------------------------------
   POPUP
--------------------------------------------- */
#popup {
  position: fixed;
  top:50%; left:50%;
  transform: translate(-50%,-50%);
  background: #1c1f23;
  color:#fff;
  padding:16px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,0.8);
  z-index:10;
  max-width:90%;
  min-width:300px;
  display:none;
}
#popup h3 { margin-top:0; margin-bottom:8px; }
#popup .close { position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; font-size:18px; }

/* ---------------------------------------------
   RESPONSIVE
--------------------------------------------- */
@media(max-width:900px){ .grid{ grid-template-columns: repeat(2,1fr); } }
@media(max-width:520px){ .grid{ grid-template-columns: repeat(1,1fr); } }
</style>
</head>

<body class="compact">
<div class="container">

  <header>
    <button id="prev-week">&lt;</button>
    <h1 id="month-title">Mois</h1>
    <button id="next-week">&gt;</button>
    <button id="btn-today">Aujourd’hui</button>
    <button id="btn-fullscreen">Plein écran</button>
  </header>

  <div class="calendar">
    <div class="grid" id="grid"></div>
  </div>

</div>

<div id="popup">
  <span class="close" onclick="document.getElementById('popup').style.display='none'">&times;</span>
  <h3 id="popup-title"></h3>
  <div id="popup-time"></div>
</div>

<script>
// ---------------------------------------
// CONFIG
// ---------------------------------------
const API_KEY = 'AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo';
const CALENDARS = [
  { id:'receptionroulier@gmail.com', key:'reception', label:'Réception', css:'c-reception'},
  { id:'smr.programme@gmail.com', key:'smr', label:'SMR', css:'c-smr'}
];
const WEEKS = 4;

function fmtDate(d){return d.toISOString().split('T')[0];}
function pad(n){return n<10?'0'+n:n;}
function fmtTime(dt){if(!dt) return ''; const d=new Date(dt); return pad(d.getHours())+':'+pad(d.getMinutes());}
function fmtPopupDate(dt){ const d=new Date(dt); const dayNames=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"]; return dayNames[d.getDay()]+' '+d.getDate(); }
function shortTitle(s,max=60){if(!s)return ''; return s.length>max?s.slice(0,max-1)+'…':s;}

// ---------------------------------------
// NAVIGATION
// ---------------------------------------
let gridStartDate;
function computeGridStart(referenceDate){
  const today = new Date(referenceDate);
  const day = today.getDay();
  const mondayThisWeek = new Date(today);
  mondayThisWeek.setDate(today.getDate()-((day+6)%7));
  const mondayLastWeek = new Date(mondayThisWeek);
  mondayLastWeek.setDate(mondayLastWeek.getDate()-7);
  return mondayLastWeek;
}
gridStartDate = computeGridStart(new Date());

// ---------------------------------------
// POPUP
// ---------------------------------------
function showPopup(title,start,end,isAllDay){
  const popup=document.getElementById('popup');
  document.getElementById('popup-title').textContent=title;
  let text;
  if(isAllDay) text='Toute la journée';
  else text='Du '+start+' au '+end;
  document.getElementById('popup-time').textContent=text;
  popup.style.display='block';
}

// ---------------------------------------
// FETCH EVENTS
// ---------------------------------------
async function fetchEventsForCalendar(calId,timeMin,timeMax){
  const base='https://www.googleapis.com/calendar/v3/calendars/';
  const url=base+encodeURIComponent(calId)+'/events?key='+encodeURIComponent(API_KEY)+'&timeMin='+encodeURIComponent(timeMin)+'&timeMax='+encodeURIComponent(timeMax)+'&singleEvents=true&orderBy=startTime&maxResults=2500';
  const res=await fetch(url);
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}

// ---------------------------------------
// BUILD DATES
// ---------------------------------------
function buildDates(start){
  const dates=[];
  for(let w=0;w<WEEKS;w++){
    for(let i=0;i<7;i++){
      const d=new Date(start);
      d.setDate(start.getDate()+w*7+i);
      dates.push(new Date(d));
    }
  }
  return dates;
}

// ---------------------------------------
// RENDER CALENDAR
// ---------------------------------------
async function renderCalendar(){
  const dates = buildDates(gridStartDate);
  const monthNames=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  document.getElementById('month-title').textContent=monthNames[dates[7].getMonth()]+' '+dates[7].getFullYear();

  const gridEl=document.getElementById('grid');
  gridEl.innerHTML='';
  dates.forEach(d=>{
    const dayEl=document.createElement('div');
    dayEl.className='day';
    dayEl.dataset.date=fmtDate(d);
    dayEl.innerHTML=
      `<div class="day-header">
         <div class="dow">${['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d.getDay()]}</div>
         <div class="date">${d.getDate()}</div>
       </div>
       <div class="events"></div>`;
    gridEl.appendChild(dayEl);
  });

  const timeMin=new Date(dates[0]); timeMin.setHours(0,0,0,0);
  const timeMax=new Date(dates[dates.length-1]); timeMax.setHours(23,59,59,999);

  try{
    const promises=CALENDARS.map(c=>fetchEventsForCalendar(
      c.id,timeMin.toISOString(),timeMax.toISOString()
    ).then(json=>({calendar:c,items:json.items||[]})).catch(err=>({calendar:c,error:err})));

    const results=await Promise.all(promises);

    const eventsByDay={};
    const seen=new Set();

    for(const res of results){
      if(res.error){console.warn('Erreur API pour',
