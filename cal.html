<html>
<head>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #1e1e1e;
    color: white;
  }

  h2 {
    text-align: center;
    color: white;
  }

  #calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-top: 20px;
  }

  .day {
    padding: 10px;
    border: 1px solid #444;
    border-radius: 10px;
    min-height: 80px;
    text-align: center;
    background-color: #2c2c2c;
    transition: transform 0.2s ease, width 0.2s ease;
    position: relative;
    overflow: hidden;
    white-space: nowrap;
  }

  .day:hover {
    transform: scale(1.25);
    width: 220px;
    z-index: 5;
  }

  .date-number {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
    font-size: 16px;
  }

  .event {
    background-color: rgba(255, 255, 255, 0.12);
    border-radius: 5px;
    margin: 3px 0;
    padding: 4px;
    font-size: 13px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .today { border-color: #ffa726; }
  .future { border-color: #29b6f6; }
  .past { background-color: #1b1b1b; }

  /* Popup */
  #eventPopup {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background-color: #2f2f2f;
    color: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    width: 300px;
  }

  #popupTitle { font-size: 20px; margin-bottom: 10px; font-weight: bold; }
  #popupText { margin-bottom: 15px; }

  button {
    background-color: #29b6f6;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    color: black;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2 id="currentWeek"></h2>
<div id="calendar"></div>

<!-- Popup -->
<div id="eventPopup">
  <div id="popupTitle"></div>
  <div id="popupText"></div>
  <button onclick="closePopup()">Fermer</button>
</div>

<script>
const API_KEY = "INSÈRE TA CLÉ API ICALCLOUD";

function fmtDate(dateObj) {
  return dateObj.toISOString().split("T")[0];
}

function computeGridStart(someDate) {
  const date = new Date(someDate);
  const day = date.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  date.setDate(date.getDate() + diff);
  return date;
}

function openPopup(title, start, end) {
  document.getElementById("popupTitle").textContent = title;

  let display = "";
  if (start) {
    display = "À " + start.split(" ")[1];
    if (end && end !== start) {
      display += " → " + end.split(" ")[1];
    }
  }

  document.getElementById("popupText").textContent = display;
  document.getElementById("eventPopup").style.display = "block";
}

function closePopup() {
  document.getElementById("eventPopup").style.display = "none";
}

async function fetchCalendar() {
  try {
    const url = `https://www.icalcloud.com/api/calendars?token=${API_KEY}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("API error");
    const { data } = await r.json();
    return data.calendars;
  } catch (e) {
    console.error(e);
    return [];
  }
}

async function fetchEventsForCalendar(cal) {
  try {
    const u = `https://www.icalcloud.com/api/calendars/${cal.key}/events?token=${API_KEY}`;
    const r = await fetch(u);
    if (!r.ok) return [];
    const { data } = await r.json();
    return data.events || [];
  } catch (e) {
    console.error(e);
    return [];
  }
}

let gridStartDate = computeGridStart(new Date());
let allEvents = {};

async function renderCalendar() {
  const now = new Date();
  const start = new Date(gridStartDate);
  const end = new Date(start);
  end.setDate(start.getDate() + 6);

  document.getElementById("currentWeek").textContent =
    `Semaine du ${fmtDate(start)} au ${fmtDate(end)}`;

  const calendars = await fetchCalendar();

  const eventsByDay = {};

  for (const cal of calendars) {
    const evts = await fetchEventsForCalendar(cal);
    for (const it of evts) {
      const start = new Date(it.start);
      const end = it.end ? new Date(it.end) : null;
      const isAllDay = (!it.timezone) && (!it.start.includes("T"));

      // Multi-jours corrigé
      if (end && fmtDate(start) !== fmtDate(end)) {
        let d = new Date(start);
        while (d <= end) {
          const key = fmtDate(d);
          if (!eventsByDay[key]) eventsByDay[key] = [];
          eventsByDay[key].push({
            title: it.summary || "(sans titre)",
            start: it.start,
            end: it.end,
            allDay: isAllDay,
            key: it.id
          });
          d.setDate(d.getDate() + 1);
        }
      } else {
        const k = fmtDate(start);
        if (!eventsByDay[k]) eventsByDay[k] = [];
        eventsByDay[k].push({
          title: it.summary || "(sans titre)",
          start: it.start,
          end: it.end,
          allDay: isAllDay,
          key: it.id
        });
      }
    }
  }

  allEvents = eventsByDay;
  buildGrid();
}

function buildGrid() {
  const container = document.getElementById("calendar");
  container.innerHTML = "";

  for (let i = 0; i < 7; i++) {
    const dayDate = new Date(gridStartDate);
    dayDate.setDate(dayDate.getDate() + i);
    const key = fmtDate(dayDate);

    const div = document.createElement("div");
    div.className = "day";

    const today = new Date(); today.setHours(0,0,0,0);
    const dd = new Date(dayDate); dd.setHours(0,0,0,0);

    if (dd.getTime() === today.getTime()) div.classList.add("today");
    else if (dd > today) div.classList.add("future");
    else div.classList.add("past");

    const num = document.createElement("div");
    num.className = "date-number";
    num.textContent = dayDate.getDate();
    div.appendChild(num);

    const evts = allEvents[key] || [];
    for (const ev of evts) {
      const eDiv = document.createElement("div");
      eDiv.className = "event";

      const startTime = ev.start.includes("T") ? ev.start.split("T")[1].substring(0,5) : "";

      eDiv.textContent = `${startTime} — ${ev.title}`;

      eDiv.onclick = () => openPopup(ev.title, ev.start, ev.end);

      div.appendChild(eDiv);
    }

    container.appendChild(div);
  }
}

renderCalendar();
setInterval(renderCalendar, 60000);
</script>

</body>
</html>
